name: CI/CD frontend


on:
  push:
    branches: [ "main" ]
    paths:
      - 'front/**'
  pull_request:
    branches: [ "main" ]
    paths:
    - 'front/**'

jobs:

  build:

    runs-on: ubuntu-latest
    steps:
      - name: clone the source code for the backend
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      - name: Install & build Angular
        run: |
          cd front          
          npm ci
          npm run build
          npm run test:ci
        # publish code coverage to GITHUB with artifact
      - name: Upload code coverage to GitHub - Frontend
        uses: actions/upload-artifact@v4
        with:
          name: code-coverage-front
          path: front/coverage/bobapp/

      - name: SonarQube Scan - Frontend
        uses: SonarSource/sonarcloud-github-action@master
        with:
          projectBaseDir: front
          args: >
            -Dsonar.projectKey=aflouat-bobapp-front
            -Dsonar.organization=aflouat
            -Dsonar.host.url=https://sonarcloud.io
            -Dsonar.sources=src
            -Dsonar.exclusions=node_modules/**,dist/**
            -Dsonar.tests=src
            -Dsonar.test.inclusions=**/*.spec.ts
            -Dsonar.typescript.lcov.reportPaths=front/coverage/bobapp/lcov.info
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      - name: Login to Docker Hub
        run: echo "${{ secrets.DOCKERHUB_PASSWORD }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Build front Docker image
        run: |
            docker build -t aflouat/bobapp-front:latest -f front/Dockerfile front

      - name: Push Docker image to Docker Hub
        run: |
          docker tag aflouat/bobapp-front:latest aflouat/bobapp-front:${{ github.sha }}
          docker push aflouat/bobapp-front:${{ github.sha }}
          docker push aflouat/bobapp-front:latest

